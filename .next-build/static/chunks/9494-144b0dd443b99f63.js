"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9494],{20:(e,r,t)=>{t.d(r,{As:()=>l,OJ:()=>i,cy:()=>a});var o=t(5155),n=t(2115),s=t(6414);let a=(0,n.createContext)(null);function i(e){let{children:r}=e,[t,i]=(0,n.useState)(null),[l,c]=(0,n.useState)(null),[u,d]=(0,n.useState)(!0);(0,n.useEffect)(()=>{let e=(()=>{let e="https://qrowzznnnarfogfbnnow.supabase.co";if(!e)return"default";let r=e.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return r?r[1]:"default"})();console.log("Auth cookies at startup:",document.cookie.split(";").map(e=>e.trim()).filter(e=>e.startsWith("sb-")||e.includes("supabase"))),console.log("Looking for cookie format:","sb-".concat(e,"-auth-token")),s.N.auth.getUser().then(e=>{let{data:{user:r},error:t}=e;t&&console.error("Error getting initial user:",t),console.log("Initial auth user:",r?"Present":"None",r?"(User: ".concat(r.email,")"):""),i(null!=r?r:null),r?p(r.id):d(!1)});let{data:{subscription:r}}=s.N.auth.onAuthStateChange(async(e,r)=>{var t;if(console.log("Auth state change event:",e),console.log("Session after event:",r?"Present":"None"),i(null!=(t=null==r?void 0:r.user)?t:null),null==r?void 0:r.user){if("SIGNED_IN"===e||"TOKEN_REFRESHED"===e)try{await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r.access_token,refresh_token:r.refresh_token}),credentials:"include"})}catch(e){console.warn("Failed to sync auth cookies on state change:",e)}p(r.user.id)}else c(null),d(!1)});return()=>{r.unsubscribe()}},[]);let p=async e=>{try{let{data:r,error:t}=await s.N.from("users").select("*").eq("id",e).single();if(t)throw t;c(r)}catch(e){console.error("Error fetching user data:",e),c(null)}finally{d(!1)}},h=async(e,r)=>{try{console.log("Attempting sign in for:",e),await s.N.auth.signOut();let{data:t,error:o}=await s.N.auth.signInWithPassword({email:e,password:r});return t.session&&await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:t.session.access_token,refresh_token:t.session.refresh_token}),credentials:"include"}),{error:o}}catch(e){return console.error("Unexpected error during sign in:",e),{error:e}}},g=async()=>{try{await s.N.auth.signOut(),console.log("Sign out completed. Session cleared.")}catch(e){console.error("Error signing out:",e)}},f=async(e,r,t)=>{try{console.log("Attempting sign up for:",e);let{data:n,error:a}=await s.N.auth.signUp({email:e,password:r,options:{data:{name:t},emailRedirectTo:"".concat(window.location.origin,"/signin")}});if(a)throw a;let i={success:!a,user:n.user?"".concat(n.user.email):"Missing",session:n.session?"Present":"Missing (email confirmation may be required)"};console.log("Sign up response:",i);let l=!n.session;if(n.user){var o;return{error:null,requiresEmailConfirmation:l,email:null!=(o=n.user.email)?o:e}}throw Error("Signup failed. Please try again.")}catch(e){return console.error("Error during sign up:",e),{error:e,requiresEmailConfirmation:!1}}},m=async e=>{try{let{error:r}=await s.N.auth.resetPasswordForEmail(e,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(r)return{error:r};return{error:null}}catch(e){return console.error("Error sending password reset email:",e),{error:e}}},y=async(e,r)=>{try{let{data:t,error:o}=await s.N.auth.signInWithOAuth({provider:e,options:{redirectTo:null!=r?r:"".concat(window.location.origin,"/"),queryParams:{prompt:"select_account"}}});if(o)throw o;return{error:null}}catch(e){return console.error("OAuth sign-in error:",e),{error:e}}};return(0,o.jsx)(a.Provider,{value:{user:t,dbUser:l,loading:u,signIn:h,signOut:g,signUp:f,signInWithProvider:y,resetPassword:m,checkPermission:e=>{let r=null==l?void 0:l.role;return!!r&&("admin"===e?"admin"===r:"teacher"===e?"admin"===r||"teacher"===r:"student"===e)}},children:r})}function l(){let e=(0,n.useContext)(a);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},4387:(e,r,t)=>{t.d(r,{d:()=>a,e:()=>s});var o=t(9535),n=t(6738);async function s(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return console.log("No user ID provided"),{data:[],error:"User not authenticated",count:0};try{console.log("Fetching enrollments for user: ".concat(e));let t=(0,o.createBrowserClient)("https://qrowzznnnarfogfbnnow.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb3d6em5ubmFyZm9nZmJubm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjg1MzUsImV4cCI6MjA2NzY0NDUzNX0.MkCeFSLoOyGl-y1_eZTXTXXV8hGOJM7WuBV7gvLc_rI"),{limit:n=50,offset:s=0,sortBy:a="enrolledAt",sortOrder:i="desc",status:l="all"}=r;console.log("Query params: limit=".concat(n,", offset=").concat(s,", sortBy=").concat(a,", sortOrder=").concat(i,", status=").concat(l));let c=t.from("enrollments").select("\n        id,\n        status,\n        enrolled_at,\n        course:course_id (\n          id,\n          title,\n          description,\n          thumbnail_url,\n          created_at,\n          creator_id,\n          playback_id\n        )\n        ",{count:"exact"}).eq("user_id",e);"all"!==l&&(c=c.eq("status",l));let{data:u,error:d,count:p}=await c.order("title"===a?"course.title":"enrolled_at",{ascending:"asc"===i}).range(s,s+n-1);if(d)return console.error("Supabase error:",d),{data:[],error:d.message,count:0};if(!(null==u?void 0:u.length))return console.log("No enrollments found for user:",e),{data:[],error:null,count:null!=p?p:0};let h={};try{let r=u.map(e=>{var r,t;return Array.isArray(e.course)?null==(r=e.course[0])?void 0:r.id:null==(t=e.course)?void 0:t.id}).filter(Boolean);if(r.length>0){let{data:o,error:n}=await t.from("courses_progress").select("course_id, progress, updated_at").eq("user_id",e).in("course_id",r);!n&&o&&(h=o.reduce((e,r)=>{var t;return e[r.course_id]={progress:Number(null!=(t=r.progress)?t:0),updated_at:r.updated_at},e},{}))}}catch(e){console.warn("Could not fetch persistent course progress:",e)}let g=u.map(e=>{var r,t,o,n;let s={id:e.id,status:e.status,enrolled_at:e.enrolled_at},a=Array.isArray(e.course)?e.course[0]:e.course,i={id:a.id,title:a.title,description:a.description,thumbnail_url:a.thumbnail_url,created_at:a.created_at,creator_id:a.creator_id,playback_id:a.playback_id},l=null!=(o=null==(r=h[i.id])?void 0:r.progress)?o:0,c=null==(t=h[i.id])?void 0:t.updated_at;if(0===l||void 0===c)try{{let e="course-progress-".concat(i.id),r=localStorage.getItem(e);if(r){let e=JSON.parse(r);l=null!=(n=e.progress)?n:l,c=null!=c?c:e.lastUpdated}}}catch(e){console.warn("Could not read local progress:",e)}return{id:i.id,title:i.title,description:i.description,thumbnail_url:i.thumbnail_url,created_at:i.created_at,creator_id:i.creator_id,progress:l,lastAccessedAt:c,playbackId:i.playback_id,enrollment:s}});return console.log("Returning ".concat(g.length," enrolled course(s)")),{data:g,error:null,count:null!=p?p:0}}catch(e){return console.error("Failed to get enrolled courses:",e),{data:[],error:"Failed to fetch enrolled courses",count:0}}}async function a(e,r){if(!e)return console.log("No user ID provided"),{data:null,error:"User not authenticated"};if(!r)return console.log("No course ID provided"),{data:null,error:"Course ID is required"};try{var t,s,a,i;let l;console.log("Fetching enrollment for user: ".concat(e," and course: ").concat(r));let c=(0,o.createBrowserClient)("https://qrowzznnnarfogfbnnow.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb3d6em5ubmFyZm9nZmJubm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjg1MzUsImV4cCI6MjA2NzY0NDUzNX0.MkCeFSLoOyGl-y1_eZTXTXXV8hGOJM7WuBV7gvLc_rI"),{data:u,error:d}=await c.from("enrollments").select("\n        id,\n        status,\n        enrolled_at,\n        course:course_id (\n          id,\n          title,\n          description,\n          thumbnail_url,\n          created_at,\n          creator_id,\n          playback_id,\n          chapters\n        )\n      ").eq("user_id",e).eq("course_id",r).eq("status","active").single();if(d)return console.error("Supabase error:",d),{data:null,error:d.message};if(!u)return console.log("No enrollment found for user:",e,"and course:",r),{data:null,error:"Not enrolled in this course"};let p=Array.isArray(u.course)?u.course[0]:u.course,h=0;try{let{data:r,error:o}=await c.from("courses_progress").select("progress, updated_at").eq("user_id",e).eq("course_id",p.id).maybeSingle();!o&&r&&(h=Number(null!=(t=r.progress)?t:0),l=null!=(s=r.updated_at)?s:void 0)}catch(e){console.warn("Could not fetch persisted progress:",e)}if(void 0===l)try{{let e="course-progress-".concat(p.id),r=localStorage.getItem(e);if(r){let e=JSON.parse(r);h=null!=(a=e.progress)?a:h,l=null!=(i=e.lastUpdated)?i:l}}}catch(e){console.warn("Could not read local progress:",e)}let g=new Date().toISOString();if(!l)try{{let e="course-progress-".concat(p.id);localStorage.setItem(e,JSON.stringify({progress:h,lastUpdated:g})),l=g}}catch(e){console.warn("Could not update last accessed timestamp:",e)}return{data:{id:p.id,title:p.title,description:p.description,thumbnail_url:p.thumbnail_url,created_at:p.created_at,creator_id:p.creator_id,progress:h,lastAccessedAt:null!=l?l:g,chapters:(0,n.UQ)(p.chapters),enrollment:{id:u.id,status:u.status,enrolled_at:u.enrolled_at},playbackId:p.playback_id},error:null}}catch(e){return console.error("Failed to get enrolled course:",e),{data:null,error:"Failed to fetch enrolled course"}}}},6414:(e,r,t)=>{t.d(r,{N:()=>l});var o=t(5647);let n="https://qrowzznnnarfogfbnnow.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb3d6em5ubmFyZm9nZmJubm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjg1MzUsImV4cCI6MjA2NzY0NDUzNX0.MkCeFSLoOyGl-y1_eZTXTXXV8hGOJM7WuBV7gvLc_rI";if(!n)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_URL");if(!s)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_ANON_KEY");let a=(()=>{if(!n)return"default";let e=n.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return e?e[1]:"default"})();console.log("Supabase project ref for cookies:",a);let i={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storageKey:"sb-".concat(a,"-auth-token"),cookieOptions:{name:"sb-".concat(a,"-auth-token"),path:"/",sameSite:"Lax",secure:!0,maxAge:604800}}};console.log("Supabase client initialized with cookie config:",{cookieName:i.auth.cookieOptions.name,cookiePath:i.auth.cookieOptions.path,detectSessionInUrl:i.auth.detectSessionInUrl,persistSession:i.auth.persistSession});let l=(0,o.UU)(n,s,i);l.auth.getUser().then(()=>{}),l.auth.onAuthStateChange((e,r)=>{console.log("Supabase auth event:",e)}),window.addEventListener("focus",()=>{l.auth.refreshSession().catch(e=>{console.error("Error refreshing Supabase session on focus:",e)})})},6738:(e,r,t)=>{function o(e){return{id:e.id,title:e.title,startTime:e.start_time,duration:e.duration,description:e.description,thumbnail:e.thumbnail_url}}function n(e){return!!e&&"object"==typeof e&&"string"==typeof e.id&&"string"==typeof e.title&&"number"==typeof e.start_time&&(void 0===e.duration||"number"==typeof e.duration)&&(void 0===e.description||"string"==typeof e.description)&&(void 0===e.thumbnail_url||"string"==typeof e.thumbnail_url)}function s(e){return!!e&&"object"==typeof e&&"string"==typeof e.id&&"string"==typeof e.title&&"number"==typeof e.startTime&&(void 0===e.duration||"number"==typeof e.duration)&&(void 0===e.description||"string"==typeof e.description)&&(void 0===e.thumbnail||"string"==typeof e.thumbnail)&&(void 0===e.flashcard||"boolean"==typeof e.flashcard)}function a(e){try{let r=e;if("string"==typeof r&&(r=JSON.parse(r)),!Array.isArray(r))return[];if(r.every(s))return r;if(r.every(n))return r.map(o);let t=[];for(let e of r)s(e)?t.push(e):n(e)&&t.push(o(e));return t}catch(e){return[]}}t.d(r,{UQ:()=>a})}}]);