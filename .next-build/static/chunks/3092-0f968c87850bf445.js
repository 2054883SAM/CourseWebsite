"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3092],{1393:(e,r,t)=>{t.d(r,{NJ:()=>c,Ox:()=>l,W9:()=>i,YG:()=>o,bW:()=>n});var s=t(6414);function a(e,r){if(console.error("Error while trying to ".concat(r,":"),e),e instanceof Error&&"Request timed out"===e.message)throw Error("Taking longer than expected to ".concat(r,". Please check your connection and try again."));throw e}async function n(){try{let{data:e,error:r}=await s.N.from("courses").select("categorie").not("categorie","is",null);if(r)throw r;if(!e)return[];let t=e.reduce((e,r)=>(r.categorie&&(e[r.categorie]=(e[r.categorie]||0)+1),e),{});return Object.entries(t).map(e=>{let[r,t]=e;return{categorie:r,count:t}})}catch(e){a(e,"load categories")}}async function c(e){try{let{query:r="",creator_id:t,category:a,sort_by:n="created_at",sort_order:c="desc",page:o=1,limit:i=10}=e||{},l=(o-1)*i,d=s.N.from("courses").select("*, users!creator_id(name, photo_url, bio)");r&&(d=d.ilike("title","%".concat(r,"%"))),t&&(d=d.eq("creator_id",t)),a&&(d=d.eq("categorie",a)),d=d.order(n,{ascending:"asc"===c}).range(l,l+i-1);let{data:u,error:h}=await d;if(h)throw h;if(!u)return[];return u.map(e=>({...e,creator:e.users}))}catch(e){a(e,"load courses")}}async function o(e){try{let{data:r,error:t}=await s.N.from("courses").select("*, users!creator_id(id, name, email, photo_url, role, bio)").eq("id",e).single();if(t)throw t;if(!r)return null;let{count:a}=await s.N.from("sections").select("*",{count:"exact",head:!0}).eq("course_id",e);return{...r,creator:r.users,section_count:a||0}}catch(r){console.error("Error fetching course with ID ".concat(e,":"),r),a(r,"load course")}}async function i(e){try{let{data:r,error:t}=await s.N.from("sections").select("*").eq("course_id",e).order("section_number",{ascending:!0});if(t)throw t;if(!r)return[];return r.map(e=>({id:e.id,course_id:e.course_id,section_number:e.section_number,title:e.title,duration:e.duration,playback_id:e.playback_id,chapters:e.chapters?Array.isArray(e.chapters)?e.chapters:JSON.parse(e.chapters):[],questions:e.questions?Array.isArray(e.questions)?e.questions:JSON.parse(e.questions):[],created_at:e.created_at}))}catch(r){console.error("Error fetching sections for course ".concat(e,":"),r),a(r,"load course sections")}}async function l(e){try{let{data:r,error:t}=await s.N.from("sections").select("*").eq("id",e).single();if(t)throw t;if(!r)return null;return{id:r.id,course_id:r.course_id,section_number:r.section_number,title:r.title,duration:r.duration,playback_id:r.playback_id,chapters:r.chapters?Array.isArray(r.chapters)?r.chapters:JSON.parse(r.chapters):[],questions:r.questions?Array.isArray(r.questions)?r.questions:JSON.parse(r.questions):[],created_at:r.created_at}}catch(r){console.error("Error fetching section with ID ".concat(e,":"),r),a(r,"load section")}}},3092:(e,r,t)=>{t.r(r),t.d(r,{default:()=>g});var s=t(5155),a=t(2115),n=t(5695),c=t(20),o=t(4387),i=t(1393),l=t(6414);async function d(e,r){try{let{data:t,error:s}=await l.N.from("section_progress").select("*").eq("user_id",e).eq("course_id",r);if(s)throw s;return t||[]}catch(e){return console.error("Error fetching user course progress:",e),[]}}let u=e=>{if(e<1)return"< 1 min";if(e<60)return"".concat(Math.round(e)," min");let r=Math.floor(e/60),t=Math.round(e%60);return 0===t?"".concat(r,"h"):"".concat(r,"h ").concat(t,"min")},h=e=>{let{sections:r,courseId:t,className:a="",isLoading:c=!1,progress:o=[],onSectionClick:i}=e,l=(0,n.useRouter)();if(!r||0===r.length)return(0,s.jsx)("div",{className:"p-8 text-center text-gray-500 ".concat(a),children:(0,s.jsxs)("div",{className:"mx-auto max-w-md",children:[(0,s.jsx)("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700",children:(0,s.jsx)("svg",{className:"h-8 w-8 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})})}),(0,s.jsx)("h3",{className:"mb-2 text-lg font-medium text-gray-900 dark:text-white",children:"No sections available"}),(0,s.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"This course doesn't have any video sections yet."})]})});let d=e=>o.find(r=>r.sectionId===e)||{sectionId:e,completed:!1,progressPercentage:0},h=e=>{if(0===e)return!0;let t=r[e-1];return!t||!0===d(t.id).quizPassed},m=(e,r)=>{if(!h(r))return void alert("Vous devez terminer la section pr\xe9c\xe9dente avec succ\xe8s (70% ou plus au quiz) pour acc\xe9der \xe0 cette section.");i?i(e):l.push("/my-learning/".concat(t,"/section/").concat(e.id))};return(0,s.jsxs)("div",{className:"rounded-lg border border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-800 ".concat(a),children:[(0,s.jsxs)("div",{className:"border-b border-gray-200 p-6 dark:border-gray-700",children:[(0,s.jsxs)("h3",{className:"flex items-center text-xl font-semibold text-gray-900 dark:text-white",children:[(0,s.jsx)("svg",{className:"mr-3 h-6 w-6 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),"Course Content"]}),(0,s.jsxs)("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:[r.length," section",1!==r.length?"s":""," • ",u(r.reduce((e,r)=>e+(r.duration||0),0))," ","total"]}),o.length>0&&(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsxs)("div",{className:"mb-2 flex justify-between text-sm text-gray-600 dark:text-gray-400",children:[(0,s.jsx)("span",{children:"Overall Progress"}),(0,s.jsxs)("span",{children:[Math.round(o.filter(e=>e.completed).length/r.length*100),"%"]})]}),(0,s.jsx)("div",{className:"h-2 w-full rounded-full bg-gray-200 dark:bg-gray-700",children:(0,s.jsx)("div",{className:"h-2 rounded-full bg-green-500 transition-all duration-300",style:{width:"".concat(o.filter(e=>e.completed).length/r.length*100,"%")}})})]})]}),(0,s.jsx)("div",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:r.map((e,r)=>{let t=d(e.id),a=t.completed,n=t.progressPercentage,o=h(r),i=t.quizScore,l=t.quizPassed;return(0,s.jsx)("div",{"data-testid":"section-".concat(e.id),className:"\n                transition-colors duration-200\n                ".concat(o?"hover:bg-gray-50 dark:hover:bg-gray-700/50":"opacity-50","\n                ").concat(a?"bg-green-50 dark:bg-green-900/10":"","\n                ").concat(o?"":"bg-gray-100 dark:bg-gray-800","\n              "),children:(0,s.jsx)("button",{"data-testid":"section-button-".concat(e.id),onClick:()=>m(e,r),disabled:c||!o,className:"w-full p-6 text-left focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 ".concat(c||!o?"cursor-not-allowed opacity-50":""),"aria-label":"Section ".concat(e.section_number,": ").concat(e.title).concat(o?"":" (Locked)"),children:(0,s.jsxs)("div",{className:"flex items-start justify-between",children:[(0,s.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,s.jsxs)("div",{className:"mb-2 flex items-center",children:[(0,s.jsx)("span",{className:"mr-4 flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full text-sm font-medium ".concat(o?a?"bg-green-100 text-green-700 dark:bg-green-900/20 dark:text-green-300":"bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300":"bg-gray-200 text-gray-500 dark:bg-gray-700 dark:text-gray-400"),children:o?a?(0,s.jsx)("svg",{className:"h-4 w-4",fill:"currentColor",viewBox:"0 0 20 20",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}):e.section_number:(0,s.jsx)("svg",{className:"h-4 w-4",fill:"currentColor",viewBox:"0 0 20 20",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z",clipRule:"evenodd"})})}),(0,s.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,s.jsx)("h4",{className:"truncate text-lg font-medium ".concat(a?"text-green-700 dark:text-green-300":"text-gray-900 dark:text-white"),children:e.title}),e.chapters&&e.chapters.length>0&&(0,s.jsxs)("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:[e.chapters.length," chapter",1!==e.chapters.length?"s":""]})]})]}),n>0&&(0,s.jsxs)("div",{className:"mb-2 ml-12",children:[(0,s.jsxs)("div",{className:"mb-1 flex justify-between text-xs text-gray-500 dark:text-gray-400",children:[(0,s.jsxs)("span",{children:["Video Progress: ",n,"%"]}),null!=i&&(0,s.jsxs)("span",{className:"".concat(l?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"),children:["Quiz: ",i,"% ",l?"✓":"✗"]})]}),(0,s.jsx)("div",{className:"h-1.5 w-full rounded-full bg-gray-200 dark:bg-gray-700",children:(0,s.jsx)("div",{className:"h-1.5 rounded-full transition-all duration-300 ".concat(a?"bg-green-500":"bg-blue-500"),style:{width:"".concat(n,"%")}})})]}),t.lastWatchedAt&&(0,s.jsxs)("p",{className:"ml-12 text-xs text-gray-400 dark:text-gray-500",children:["Last watched: ",new Date(t.lastWatchedAt).toLocaleDateString()]})]}),(0,s.jsxs)("div",{className:"ml-6 flex-shrink-0 text-right",children:[(0,s.jsx)("div",{className:"mb-2 text-sm text-gray-500 dark:text-gray-400",children:u(e.duration||0)}),(0,s.jsx)("div",{className:"inline-flex h-10 w-10 items-center justify-center rounded-full transition-colors ".concat(a?"bg-green-100 text-green-600 dark:bg-green-900/20 dark:text-green-400":"bg-blue-100 text-blue-600 hover:bg-blue-200 dark:bg-blue-900/20 dark:text-blue-400 dark:hover:bg-blue-900/40"),children:a?(0,s.jsx)("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}):(0,s.jsx)("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"})})})]})]})})},e.id)})})]})};var m=t(7667);function g(){let e=(0,n.useParams)(),r=(0,n.useRouter)(),{user:t,dbUser:l,loading:u}=(0,c.As)(),[g,x]=(0,a.useState)(null),[f,b]=(0,a.useState)([]),[y,p]=(0,a.useState)([]),[v,j]=(0,a.useState)(!0),[N,w]=(0,a.useState)(null),k=(0,a.useRef)(!1),_=e.courseId;return((0,a.useEffect)(()=>{let e=()=>{k.current=!1;try{sessionStorage.removeItem("course_".concat(_)),sessionStorage.removeItem("course_sections_".concat(_))}catch(e){console.warn("Failed to clear cache on focus:",e)}};return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)},[_]),(0,a.useEffect)(()=>{k.current||g||e();async function e(){if(!u){if(!t)return void r.replace("/unauthorized?requiredRole=student");try{j(!0);try{let e=sessionStorage.getItem("course_".concat(_)),r=sessionStorage.getItem("course_sections_".concat(_));if(e&&r){let t=JSON.parse(e),s=JSON.parse(r);console.log("Using cached course data and sections"),x(t),b(s),k.current=!0,j(!1);return}}catch(e){console.warn("Failed to read from session storage:",e)}if(console.log("Fetching course data and sections from API"),(null==l?void 0:l.role)==="admin"){let[e,r,s]=await Promise.all([(0,i.YG)(_),(0,i.W9)(_),d(t.id,_)]);if(!e){w("Course not found"),j(!1);return}let a={id:e.id,title:e.title,description:e.description,thumbnail_url:e.thumbnail_url,created_at:e.created_at,creator_id:e.creator_id,section_count:e.section_count,creator:e.creator};try{sessionStorage.setItem("course_".concat(_),JSON.stringify(a)),sessionStorage.setItem("course_sections_".concat(_),JSON.stringify(r))}catch(e){console.warn("Failed to cache course data:",e)}k.current=!0,x(a),b(r),p(s),j(!1);return}let[e,s,a]=await Promise.all([(0,o.d)(t.id,_),(0,i.W9)(_),d(t.id,_)]);if(e.error||!e.data){w(e.error||"Course not found"),r.replace("/unauthorized?requiredRole=student");return}try{sessionStorage.setItem("course_".concat(_),JSON.stringify(e.data)),sessionStorage.setItem("course_sections_".concat(_),JSON.stringify(s))}catch(e){console.warn("Failed to cache course data:",e)}k.current=!0,x(e.data),b(s),p(a)}catch(e){w(e instanceof Error?e.message:"An error occurred")}finally{j(!1)}}}},[_,t,l,u,r,g]),v||u)?(0,s.jsx)("div",{className:"flex h-screen items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)(m.k,{}),(0,s.jsx)("p",{className:"mt-4 text-gray-600 dark:text-gray-400",children:"Loading your course content..."})]})}):N?(0,s.jsx)("div",{className:"flex h-screen items-center justify-center",children:(0,s.jsxs)("div",{className:"max-w-md rounded-lg bg-red-50 p-6 text-center dark:bg-red-900/20",children:[(0,s.jsx)("h2",{className:"mb-4 text-xl font-semibold text-red-800 dark:text-red-400",children:"Error"}),(0,s.jsx)("p",{className:"text-red-700 dark:text-red-300",children:N})]})}):g?(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 py-8 dark:bg-gray-900",children:(0,s.jsxs)("div",{className:"mx-auto max-w-4xl px-4 sm:px-6 lg:px-8",children:[(0,s.jsx)("div",{className:"mb-8 rounded-lg border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800",children:(0,s.jsx)("div",{className:"p-8",children:(0,s.jsxs)("div",{className:"flex items-start space-x-6",children:[g.thumbnail_url&&(0,s.jsx)("div",{className:"flex-shrink-0",children:(0,s.jsx)("img",{src:g.thumbnail_url,alt:g.title,className:"h-24 w-32 rounded-lg border border-gray-200 object-cover dark:border-gray-700"})}),(0,s.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,s.jsx)("h1",{className:"mb-2 text-3xl font-bold text-gray-900 dark:text-white",children:g.title}),g.description&&(0,s.jsx)("p",{className:"mb-4 text-lg text-gray-600 dark:text-gray-300",children:g.description}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center space-x-6 text-sm text-gray-500 dark:text-gray-400",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("svg",{className:"mr-1 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),f.length," section",1!==f.length?"s":""]}),(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("svg",{className:"mr-1 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),Math.round(f.reduce((e,r)=>e+(r.duration||0),0))," ","minutes total"]}),g.creator&&(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("svg",{className:"mr-1 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"By ",g.creator.name]})]})]})]})})}),(0,s.jsx)(h,{sections:f,courseId:_,className:"shadow-sm",progress:y.map(e=>({sectionId:e.section_id,completed:e.completed,progressPercentage:e.progress_percentage,lastWatchedAt:e.last_watched_at,quizScore:e.quiz_score,quizPassed:e.quiz_passed})),onSectionClick:e=>{try{sessionStorage.removeItem("course_".concat(_)),sessionStorage.removeItem("course_sections_".concat(_))}catch(e){console.warn("Failed to clear cache:",e)}r.push("/my-learning/".concat(_,"/section/").concat(e.id))}})]})}):null}},5695:(e,r,t)=>{var s=t(8999);t.o(s,"useParams")&&t.d(r,{useParams:function(){return s.useParams}}),t.o(s,"usePathname")&&t.d(r,{usePathname:function(){return s.usePathname}}),t.o(s,"useRouter")&&t.d(r,{useRouter:function(){return s.useRouter}}),t.o(s,"useSearchParams")&&t.d(r,{useSearchParams:function(){return s.useSearchParams}})},7667:(e,r,t)=>{t.d(r,{k:()=>a});var s=t(5155);function a(e){let{size:r="medium",color:t="blue"}=e;return(0,s.jsx)("div",{className:"\n        ".concat({small:"h-4 w-4 border-2",medium:"h-8 w-8 border-2",large:"h-12 w-12 border-3"}[r],"\n        ").concat({blue:"border-blue-200 border-t-blue-600",white:"border-gray-200/30 border-t-white"}[t],"\n        animate-spin rounded-full border-solid\n      "),role:"status","aria-label":"Chargement",children:(0,s.jsx)("span",{className:"sr-only",children:"Chargement..."})})}}}]);