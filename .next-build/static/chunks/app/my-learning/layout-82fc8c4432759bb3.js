(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3813],{20:(e,r,t)=>{"use strict";t.d(r,{As:()=>c,OJ:()=>a,cy:()=>i});var n=t(5155),s=t(2115),o=t(6414);let i=(0,s.createContext)(null);function a(e){let{children:r}=e,[t,a]=(0,s.useState)(null),[c,l]=(0,s.useState)(null),[u,h]=(0,s.useState)(!0);(0,s.useEffect)(()=>{let e=(()=>{let e="https://qrowzznnnarfogfbnnow.supabase.co";if(!e)return"default";let r=e.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return r?r[1]:"default"})();console.log("Auth cookies at startup:",document.cookie.split(";").map(e=>e.trim()).filter(e=>e.startsWith("sb-")||e.includes("supabase"))),console.log("Looking for cookie format:","sb-".concat(e,"-auth-token")),o.N.auth.getUser().then(e=>{let{data:{user:r},error:t}=e;t&&console.error("Error getting initial user:",t),console.log("Initial auth user:",r?"Present":"None",r?"(User: ".concat(r.email,")"):""),a(null!=r?r:null),r?d(r.id):h(!1)});let{data:{subscription:r}}=o.N.auth.onAuthStateChange(async(e,r)=>{var t;if(console.log("Auth state change event:",e),console.log("Session after event:",r?"Present":"None"),a(null!=(t=null==r?void 0:r.user)?t:null),null==r?void 0:r.user){if("SIGNED_IN"===e||"TOKEN_REFRESHED"===e)try{await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r.access_token,refresh_token:r.refresh_token}),credentials:"include"})}catch(e){console.warn("Failed to sync auth cookies on state change:",e)}d(r.user.id)}else l(null),h(!1)});return()=>{r.unsubscribe()}},[]);let d=async e=>{try{let{data:r,error:t}=await o.N.from("users").select("*").eq("id",e).single();if(t)throw t;l(r)}catch(e){console.error("Error fetching user data:",e),l(null)}finally{h(!1)}},m=async(e,r)=>{try{console.log("Attempting sign in for:",e),await o.N.auth.signOut();let{data:t,error:n}=await o.N.auth.signInWithPassword({email:e,password:r});return t.session&&await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:t.session.access_token,refresh_token:t.session.refresh_token}),credentials:"include"}),{error:n}}catch(e){return console.error("Unexpected error during sign in:",e),{error:e}}},g=async()=>{try{await o.N.auth.signOut(),console.log("Sign out completed. Session cleared.")}catch(e){console.error("Error signing out:",e)}},f=async(e,r,t)=>{try{console.log("Attempting sign up for:",e);let{data:s,error:i}=await o.N.auth.signUp({email:e,password:r,options:{data:{name:t},emailRedirectTo:"".concat(window.location.origin,"/signin")}});if(i)throw i;let a={success:!i,user:s.user?"".concat(s.user.email):"Missing",session:s.session?"Present":"Missing (email confirmation may be required)"};console.log("Sign up response:",a);let c=!s.session;if(s.user){var n;return{error:null,requiresEmailConfirmation:c,email:null!=(n=s.user.email)?n:e}}throw Error("Signup failed. Please try again.")}catch(e){return console.error("Error during sign up:",e),{error:e,requiresEmailConfirmation:!1}}},p=async e=>{try{let{error:r}=await o.N.auth.resetPasswordForEmail(e,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(r)return{error:r};return{error:null}}catch(e){return console.error("Error sending password reset email:",e),{error:e}}},b=async(e,r)=>{try{let{data:t,error:n}=await o.N.auth.signInWithOAuth({provider:e,options:{redirectTo:null!=r?r:"".concat(window.location.origin,"/"),queryParams:{prompt:"select_account"}}});if(n)throw n;return{error:null}}catch(e){return console.error("OAuth sign-in error:",e),{error:e}}};return(0,n.jsx)(i.Provider,{value:{user:t,dbUser:c,loading:u,signIn:m,signOut:g,signUp:f,signInWithProvider:b,resetPassword:p,checkPermission:e=>{let r=null==c?void 0:c.role;return!!r&&("admin"===e?"admin"===r:"teacher"===e?"admin"===r||"teacher"===r:"student"===e)}},children:r})}function c(){let e=(0,s.useContext)(i);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},970:(e,r,t)=>{"use strict";t.d(r,{r:()=>a});var n=t(5155),s=t(20);let o=()=>(0,n.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary-600 border-t-transparent"}),(0,n.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading..."})]})}),i=()=>(0,n.jsx)("div",{className:"flex min-h-screen items-center justify-center px-4 py-12 sm:px-6 lg:px-8",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h2",{className:"mb-4 text-2xl font-bold",children:"Access Denied"}),(0,n.jsx)("p",{className:"mb-6 text-gray-600",children:"You need to be signed in to access this page."}),(0,n.jsx)("a",{href:"/signin",className:"inline-flex h-10 items-center justify-center rounded-md bg-primary-600 px-4 font-medium text-white transition-colors hover:bg-primary-700",children:"Sign In"})]})});function a(e){let{requiredRole:r,requireAuth:t=!0,loadingComponent:a=(0,n.jsx)(o,{}),unauthorizedComponent:c=(0,n.jsx)(i,{})}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(o){let{user:i,loading:l,checkPermission:u}=(0,s.As)();return l?a:t&&!i||r&&!u(r)?c:(0,n.jsx)(e,{...o})}}},5162:(e,r,t)=>{Promise.resolve().then(t.bind(t,5622))},5622:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>l});var n=t(5155),s=t(20),o=t(970),i=t(7667),a=t(5695),c=t(2115);let l=(0,o.r)(function(e){let{children:r}=e,{user:t,loading:o}=(0,s.As)(),l=(0,a.useRouter)();return((0,c.useEffect)(()=>{o||t||l.push("/signin?redirect=/my-learning")},[t,o,l]),o)?(0,n.jsx)("div",{className:"flex min-h-[50vh] items-center justify-center",children:(0,n.jsx)(i.k,{size:"large"})}):t?(0,n.jsx)(n.Fragment,{children:r}):null},{requireAuth:!0})},5695:(e,r,t)=>{"use strict";var n=t(8999);t.o(n,"useParams")&&t.d(r,{useParams:function(){return n.useParams}}),t.o(n,"usePathname")&&t.d(r,{usePathname:function(){return n.usePathname}}),t.o(n,"useRouter")&&t.d(r,{useRouter:function(){return n.useRouter}}),t.o(n,"useSearchParams")&&t.d(r,{useSearchParams:function(){return n.useSearchParams}})},6414:(e,r,t)=>{"use strict";t.d(r,{N:()=>c});var n=t(5647);let s="https://qrowzznnnarfogfbnnow.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb3d6em5ubmFyZm9nZmJubm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjg1MzUsImV4cCI6MjA2NzY0NDUzNX0.MkCeFSLoOyGl-y1_eZTXTXXV8hGOJM7WuBV7gvLc_rI";if(!s)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_URL");if(!o)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_ANON_KEY");let i=(()=>{if(!s)return"default";let e=s.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return e?e[1]:"default"})();console.log("Supabase project ref for cookies:",i);let a={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storageKey:"sb-".concat(i,"-auth-token"),cookieOptions:{name:"sb-".concat(i,"-auth-token"),path:"/",sameSite:"Lax",secure:!0,maxAge:604800}}};console.log("Supabase client initialized with cookie config:",{cookieName:a.auth.cookieOptions.name,cookiePath:a.auth.cookieOptions.path,detectSessionInUrl:a.auth.detectSessionInUrl,persistSession:a.auth.persistSession});let c=(0,n.UU)(s,o,a);c.auth.getUser().then(()=>{}),c.auth.onAuthStateChange((e,r)=>{console.log("Supabase auth event:",e)}),window.addEventListener("focus",()=>{c.auth.refreshSession().catch(e=>{console.error("Error refreshing Supabase session on focus:",e)})})},7667:(e,r,t)=>{"use strict";t.d(r,{k:()=>s});var n=t(5155);function s(e){let{size:r="medium",color:t="blue"}=e;return(0,n.jsx)("div",{className:"\n        ".concat({small:"h-4 w-4 border-2",medium:"h-8 w-8 border-2",large:"h-12 w-12 border-3"}[r],"\n        ").concat({blue:"border-blue-200 border-t-blue-600",white:"border-gray-200/30 border-t-white"}[t],"\n        animate-spin rounded-full border-solid\n      "),role:"status","aria-label":"Chargement",children:(0,n.jsx)("span",{className:"sr-only",children:"Chargement..."})})}}},e=>{var r=r=>e(e.s=r);e.O(0,[5647,8441,1684,7358],()=>r(5162)),_N_E=e.O()}]);