(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7728],{20:(e,t,r)=>{"use strict";r.d(t,{As:()=>c,OJ:()=>a,cy:()=>i});var n=r(5155),s=r(2115),o=r(6414);let i=(0,s.createContext)(null);function a(e){let{children:t}=e,[r,a]=(0,s.useState)(null),[c,l]=(0,s.useState)(null),[u,h]=(0,s.useState)(!0);(0,s.useEffect)(()=>{let e=(()=>{let e="https://qrowzznnnarfogfbnnow.supabase.co";if(!e)return"default";let t=e.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return t?t[1]:"default"})();console.log("Auth cookies at startup:",document.cookie.split(";").map(e=>e.trim()).filter(e=>e.startsWith("sb-")||e.includes("supabase"))),console.log("Looking for cookie format:","sb-".concat(e,"-auth-token")),o.N.auth.getUser().then(e=>{let{data:{user:t},error:r}=e;r&&console.error("Error getting initial user:",r),console.log("Initial auth user:",t?"Present":"None",t?"(User: ".concat(t.email,")"):""),a(null!=t?t:null),t?d(t.id):h(!1)});let{data:{subscription:t}}=o.N.auth.onAuthStateChange(async(e,t)=>{var r;if(console.log("Auth state change event:",e),console.log("Session after event:",t?"Present":"None"),a(null!=(r=null==t?void 0:t.user)?r:null),null==t?void 0:t.user){if("SIGNED_IN"===e||"TOKEN_REFRESHED"===e)try{await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:t.access_token,refresh_token:t.refresh_token}),credentials:"include"})}catch(e){console.warn("Failed to sync auth cookies on state change:",e)}d(t.user.id)}else l(null),h(!1)});return()=>{t.unsubscribe()}},[]);let d=async e=>{try{let{data:t,error:r}=await o.N.from("users").select("*").eq("id",e).single();if(r)throw r;l(t)}catch(e){console.error("Error fetching user data:",e),l(null)}finally{h(!1)}},g=async(e,t)=>{try{console.log("Attempting sign in for:",e),await o.N.auth.signOut();let{data:r,error:n}=await o.N.auth.signInWithPassword({email:e,password:t});return r.session&&await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r.session.access_token,refresh_token:r.session.refresh_token}),credentials:"include"}),{error:n}}catch(e){return console.error("Unexpected error during sign in:",e),{error:e}}},m=async()=>{try{await o.N.auth.signOut(),console.log("Sign out completed. Session cleared.")}catch(e){console.error("Error signing out:",e)}},f=async(e,t,r)=>{try{console.log("Attempting sign up for:",e);let{data:s,error:i}=await o.N.auth.signUp({email:e,password:t,options:{data:{name:r},emailRedirectTo:"".concat(window.location.origin,"/signin")}});if(i)throw i;let a={success:!i,user:s.user?"".concat(s.user.email):"Missing",session:s.session?"Present":"Missing (email confirmation may be required)"};console.log("Sign up response:",a);let c=!s.session;if(s.user){var n;return{error:null,requiresEmailConfirmation:c,email:null!=(n=s.user.email)?n:e}}throw Error("Signup failed. Please try again.")}catch(e){return console.error("Error during sign up:",e),{error:e,requiresEmailConfirmation:!1}}},p=async e=>{try{let{error:t}=await o.N.auth.resetPasswordForEmail(e,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(t)return{error:t};return{error:null}}catch(e){return console.error("Error sending password reset email:",e),{error:e}}},y=async(e,t)=>{try{let{data:r,error:n}=await o.N.auth.signInWithOAuth({provider:e,options:{redirectTo:null!=t?t:"".concat(window.location.origin,"/"),queryParams:{prompt:"select_account"}}});if(n)throw n;return{error:null}}catch(e){return console.error("OAuth sign-in error:",e),{error:e}}};return(0,n.jsx)(i.Provider,{value:{user:r,dbUser:c,loading:u,signIn:g,signOut:m,signUp:f,signInWithProvider:y,resetPassword:p,checkPermission:e=>{let t=null==c?void 0:c.role;return!!t&&("admin"===e?"admin"===t:"teacher"===e?"admin"===t||"teacher"===t:"student"===e)}},children:t})}function c(){let e=(0,s.useContext)(i);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},970:(e,t,r)=>{"use strict";r.d(t,{r:()=>a});var n=r(5155),s=r(20);let o=()=>(0,n.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary-600 border-t-transparent"}),(0,n.jsx)("p",{className:"mt-4 text-gray-600",children:"Loading..."})]})}),i=()=>(0,n.jsx)("div",{className:"flex min-h-screen items-center justify-center px-4 py-12 sm:px-6 lg:px-8",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h2",{className:"mb-4 text-2xl font-bold",children:"Access Denied"}),(0,n.jsx)("p",{className:"mb-6 text-gray-600",children:"You need to be signed in to access this page."}),(0,n.jsx)("a",{href:"/signin",className:"inline-flex h-10 items-center justify-center rounded-md bg-primary-600 px-4 font-medium text-white transition-colors hover:bg-primary-700",children:"Sign In"})]})});function a(e){let{requiredRole:t,requireAuth:r=!0,loadingComponent:a=(0,n.jsx)(o,{}),unauthorizedComponent:c=(0,n.jsx)(i,{})}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(o){let{user:i,loading:l,checkPermission:u}=(0,s.As)();return l?a:r&&!i||t&&!u(t)?c:(0,n.jsx)(e,{...o})}}},6414:(e,t,r)=>{"use strict";r.d(t,{N:()=>c});var n=r(5647);let s="https://qrowzznnnarfogfbnnow.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb3d6em5ubmFyZm9nZmJubm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjg1MzUsImV4cCI6MjA2NzY0NDUzNX0.MkCeFSLoOyGl-y1_eZTXTXXV8hGOJM7WuBV7gvLc_rI";if(!s)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_URL");if(!o)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_ANON_KEY");let i=(()=>{if(!s)return"default";let e=s.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return e?e[1]:"default"})();console.log("Supabase project ref for cookies:",i);let a={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storageKey:"sb-".concat(i,"-auth-token"),cookieOptions:{name:"sb-".concat(i,"-auth-token"),path:"/",sameSite:"Lax",secure:!0,maxAge:604800}}};console.log("Supabase client initialized with cookie config:",{cookieName:a.auth.cookieOptions.name,cookiePath:a.auth.cookieOptions.path,detectSessionInUrl:a.auth.detectSessionInUrl,persistSession:a.auth.persistSession});let c=(0,n.UU)(s,o,a);c.auth.getUser().then(()=>{}),c.auth.onAuthStateChange((e,t)=>{console.log("Supabase auth event:",e)}),window.addEventListener("focus",()=>{c.auth.refreshSession().catch(e=>{console.error("Error refreshing Supabase session on focus:",e)})})},6914:(e,t,r)=>{Promise.resolve().then(r.bind(r,9469))},9469:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>n}),r(2115);let n=(0,r(970).r)(function(e){let{children:t}=e;return t},{requiredRole:"student"})}},e=>{var t=t=>e(e.s=t);e.O(0,[5647,8441,1684,7358],()=>t(6914)),_N_E=e.O()}]);