(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[44],{20:(e,r,t)=>{"use strict";t.d(r,{As:()=>l,OJ:()=>i,cy:()=>o});var a=t(5155),s=t(2115),n=t(6414);let o=(0,s.createContext)(null);function i(e){let{children:r}=e,[t,i]=(0,s.useState)(null),[l,u]=(0,s.useState)(null),[c,d]=(0,s.useState)(!0);(0,s.useEffect)(()=>{let e=(()=>{let e="https://qrowzznnnarfogfbnnow.supabase.co";if(!e)return"default";let r=e.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return r?r[1]:"default"})();console.log("Auth cookies at startup:",document.cookie.split(";").map(e=>e.trim()).filter(e=>e.startsWith("sb-")||e.includes("supabase"))),console.log("Looking for cookie format:","sb-".concat(e,"-auth-token")),n.N.auth.getUser().then(e=>{let{data:{user:r},error:t}=e;t&&console.error("Error getting initial user:",t),console.log("Initial auth user:",r?"Present":"None",r?"(User: ".concat(r.email,")"):""),i(null!=r?r:null),r?h(r.id):d(!1)});let{data:{subscription:r}}=n.N.auth.onAuthStateChange(async(e,r)=>{var t;if(console.log("Auth state change event:",e),console.log("Session after event:",r?"Present":"None"),i(null!=(t=null==r?void 0:r.user)?t:null),null==r?void 0:r.user){if("SIGNED_IN"===e||"TOKEN_REFRESHED"===e)try{await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r.access_token,refresh_token:r.refresh_token}),credentials:"include"})}catch(e){console.warn("Failed to sync auth cookies on state change:",e)}h(r.user.id)}else u(null),d(!1)});return()=>{r.unsubscribe()}},[]);let h=async e=>{try{let{data:r,error:t}=await n.N.from("users").select("*").eq("id",e).single();if(t)throw t;u(r)}catch(e){console.error("Error fetching user data:",e),u(null)}finally{d(!1)}},m=async(e,r)=>{try{console.log("Attempting sign in for:",e),await n.N.auth.signOut();let{data:t,error:a}=await n.N.auth.signInWithPassword({email:e,password:r});return t.session&&await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:t.session.access_token,refresh_token:t.session.refresh_token}),credentials:"include"}),{error:a}}catch(e){return console.error("Unexpected error during sign in:",e),{error:e}}},g=async()=>{try{await n.N.auth.signOut(),console.log("Sign out completed. Session cleared.")}catch(e){console.error("Error signing out:",e)}},p=async(e,r,t)=>{try{console.log("Attempting sign up for:",e);let{data:s,error:o}=await n.N.auth.signUp({email:e,password:r,options:{data:{name:t},emailRedirectTo:"".concat(window.location.origin,"/signin")}});if(o)throw o;let i={success:!o,user:s.user?"".concat(s.user.email):"Missing",session:s.session?"Present":"Missing (email confirmation may be required)"};console.log("Sign up response:",i);let l=!s.session;if(s.user){var a;return{error:null,requiresEmailConfirmation:l,email:null!=(a=s.user.email)?a:e}}throw Error("Signup failed. Please try again.")}catch(e){return console.error("Error during sign up:",e),{error:e,requiresEmailConfirmation:!1}}},b=async e=>{try{let{error:r}=await n.N.auth.resetPasswordForEmail(e,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(r)return{error:r};return{error:null}}catch(e){return console.error("Error sending password reset email:",e),{error:e}}},f=async(e,r)=>{try{let{data:t,error:a}=await n.N.auth.signInWithOAuth({provider:e,options:{redirectTo:null!=r?r:"".concat(window.location.origin,"/"),queryParams:{prompt:"select_account"}}});if(a)throw a;return{error:null}}catch(e){return console.error("OAuth sign-in error:",e),{error:e}}};return(0,a.jsx)(o.Provider,{value:{user:t,dbUser:l,loading:c,signIn:m,signOut:g,signUp:p,signInWithProvider:f,resetPassword:b,checkPermission:e=>{let r=null==l?void 0:l.role;return!!r&&("admin"===e?"admin"===r:"teacher"===e?"admin"===r||"teacher"===r:"student"===e)}},children:r})}function l(){let e=(0,s.useContext)(o);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},3459:(e,r,t)=>{Promise.resolve().then(t.bind(t,7547))},5695:(e,r,t)=>{"use strict";var a=t(8999);t.o(a,"useParams")&&t.d(r,{useParams:function(){return a.useParams}}),t.o(a,"usePathname")&&t.d(r,{usePathname:function(){return a.usePathname}}),t.o(a,"useRouter")&&t.d(r,{useRouter:function(){return a.useRouter}}),t.o(a,"useSearchParams")&&t.d(r,{useSearchParams:function(){return a.useSearchParams}})},6414:(e,r,t)=>{"use strict";t.d(r,{N:()=>l});var a=t(5647);let s="https://qrowzznnnarfogfbnnow.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb3d6em5ubmFyZm9nZmJubm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjg1MzUsImV4cCI6MjA2NzY0NDUzNX0.MkCeFSLoOyGl-y1_eZTXTXXV8hGOJM7WuBV7gvLc_rI";if(!s)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_URL");if(!n)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_ANON_KEY");let o=(()=>{if(!s)return"default";let e=s.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return e?e[1]:"default"})();console.log("Supabase project ref for cookies:",o);let i={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storageKey:"sb-".concat(o,"-auth-token"),cookieOptions:{name:"sb-".concat(o,"-auth-token"),path:"/",sameSite:"Lax",secure:!0,maxAge:604800}}};console.log("Supabase client initialized with cookie config:",{cookieName:i.auth.cookieOptions.name,cookiePath:i.auth.cookieOptions.path,detectSessionInUrl:i.auth.detectSessionInUrl,persistSession:i.auth.persistSession});let l=(0,a.UU)(s,n,i);l.auth.getUser().then(()=>{}),l.auth.onAuthStateChange((e,r)=>{console.log("Supabase auth event:",e)}),window.addEventListener("focus",()=>{l.auth.refreshSession().catch(e=>{console.error("Error refreshing Supabase session on focus:",e)})})},7547:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>l});var a=t(5155),s=t(2115),n=t(970),o=t(8183),i=t(5695);let l=(0,n.r)(function(e){let{params:r}=e,{id:t}=(0,s.use)(r),n=(0,i.useRouter)(),[l,u]=(0,s.useState)(!0),[c,d]=(0,s.useState)(!1),[h,m]=(0,s.useState)(null),[g,p]=(0,s.useState)(null),[b,f]=(0,s.useState)(null),[y,x]=(0,s.useState)(""),[w,v]=(0,s.useState)(""),[N,k]=(0,s.useState)("USD"),[S,j]=(0,s.useState)(null);(0,s.useEffect)(()=>{let e=!0;return(async()=>{try{u(!0);let r=await (0,o.YG)(t);if(!e)return;if(!r)return void m("Course not found");f(r),x(r.title||""),v(r.description||"")}catch(r){console.error(r),e&&m("Failed to load course")}finally{e&&u(!1)}})(),()=>{e=!1}},[t]);let E=async e=>{if(e)try{let r=new URL(e),t="/storage/v1/object/public/course-thumbnails/",a=r.pathname.indexOf(t);if(-1!==a){let e=r.pathname.substring(a+t.length);if(e){let{error:r}=await o.ND.storage.from("course-thumbnails").remove([e]);if(r)throw r}}}catch(e){console.warn("Failed to parse/delete old thumbnail. Continuing.",e)}},_=async()=>{if(!S)return null;if(!S.type.startsWith("image/"))throw Error("Le fichier de miniature doit \xeatre une image");if(S.size>5242880)throw Error("L'image doit faire moins de 5MB");let e=S.name.split(".").pop(),r="".concat(crypto.randomUUID(),".").concat(e),t="course-thumbnails/".concat(r),{error:a}=await o.ND.storage.from("course-thumbnails").upload(t,S);if(a)throw Error("Erreur upload thumbnail: ".concat(a.message));let{data:s}=o.ND.storage.from("course-thumbnails").getPublicUrl(t);return s.publicUrl||null},P=async e=>{if(e.preventDefault(),b){m(null),p(null),d(!0);try{let e=b.thumbnail_url;S&&(await E(b.thumbnail_url),e=await _());let{error:r}=await o.ND.from("courses").update({title:y.trim(),description:w.trim(),thumbnail_url:null!=e?e:null}).eq("id",b.id);if(r)throw Error(r.message);p("Cours mis \xe0 jour avec succ\xe8s"),setTimeout(()=>{n.push("/courses/".concat(b.id))},800)}catch(e){console.error(e),m((null==e?void 0:e.message)||"\xc9chec de la mise \xe0 jour")}finally{d(!1)}}};return l?(0,a.jsxs)("div",{className:"container mx-auto px-4 py-10",children:[(0,a.jsx)("div",{className:"animate-pulse h-8 w-1/3 bg-gray-200 rounded mb-6"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"h-10 bg-gray-200 rounded"}),(0,a.jsx)("div",{className:"h-24 bg-gray-200 rounded"}),(0,a.jsx)("div",{className:"h-10 bg-gray-200 rounded"})]})]}):h?(0,a.jsx)("div",{className:"container mx-auto px-4 py-10",children:(0,a.jsx)("div",{className:"rounded border border-red-300 bg-red-50 p-4 text-red-700",children:h})}):b?(0,a.jsxs)("div",{className:"container mx-auto px-4 py-10 max-w-3xl",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold mb-6",children:"Modifier le cours"}),g&&(0,a.jsx)("div",{className:"mb-4 rounded border border-green-300 bg-green-50 p-3 text-green-700",children:g}),(0,a.jsxs)("form",{onSubmit:P,className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Titre"}),(0,a.jsx)("input",{type:"text",value:y,onChange:e=>x(e.target.value),className:"w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-3 py-2",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Description"}),(0,a.jsx)("textarea",{value:w,onChange:e=>v(e.target.value),rows:5,className:"w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-3 py-2",required:!0})]}),(0,a.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Devise"}),(0,a.jsxs)("select",{value:N,onChange:e=>k(e.target.value),className:"w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-3 py-2",children:[(0,a.jsx)("option",{value:"USD",children:"USD"}),(0,a.jsx)("option",{value:"EUR",children:"EUR"}),(0,a.jsx)("option",{value:"GBP",children:"GBP"})]})]})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1",children:"Miniature (thumbnail)"}),(0,a.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var r;j((null==(r=e.target.files)?void 0:r[0])||null)}}),b.thumbnail_url&&(0,a.jsxs)("div",{className:"mt-2 text-sm text-gray-600 dark:text-gray-400",children:["Miniature actuelle: ",(0,a.jsx)("a",{href:b.thumbnail_url,className:"text-blue-600 underline",target:"_blank",children:"voir"})]})]}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(0,a.jsx)("button",{type:"submit",disabled:c,className:"inline-flex items-center px-5 py-2 rounded-md bg-gradient-to-r from-gray-600 to-gray-800 text-white shadow hover:from-gray-700 hover:to-gray-900 disabled:opacity-60",children:c?"Enregistrement…":"Enregistrer"}),(0,a.jsx)("button",{type:"button",onClick:()=>n.push("/courses/".concat(b.id)),className:"inline-flex items-center px-5 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800",children:"Annuler"})]})]})]}):null},{requiredRole:"admin"})}},e=>{var r=r=>e(e.s=r);e.O(0,[5647,4704,8441,1684,7358],()=>r(3459)),_N_E=e.O()}]);