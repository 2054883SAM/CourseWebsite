(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4700],{20:(e,t,r)=>{"use strict";r.d(t,{As:()=>l,OJ:()=>i,cy:()=>a});var s=r(5155),o=r(2115),n=r(6414);let a=(0,o.createContext)(null);function i(e){let{children:t}=e,[r,i]=(0,o.useState)(null),[l,u]=(0,o.useState)(null),[c,d]=(0,o.useState)(!0);(0,o.useEffect)(()=>{let e=(()=>{let e="https://qrowzznnnarfogfbnnow.supabase.co";if(!e)return"default";let t=e.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return t?t[1]:"default"})();console.log("Auth cookies at startup:",document.cookie.split(";").map(e=>e.trim()).filter(e=>e.startsWith("sb-")||e.includes("supabase"))),console.log("Looking for cookie format:","sb-".concat(e,"-auth-token")),n.N.auth.getUser().then(e=>{let{data:{user:t},error:r}=e;r&&console.error("Error getting initial user:",r),console.log("Initial auth user:",t?"Present":"None",t?"(User: ".concat(t.email,")"):""),i(null!=t?t:null),t?h(t.id):d(!1)});let{data:{subscription:t}}=n.N.auth.onAuthStateChange(async(e,t)=>{var r;if(console.log("Auth state change event:",e),console.log("Session after event:",t?"Present":"None"),i(null!=(r=null==t?void 0:t.user)?r:null),null==t?void 0:t.user){if("SIGNED_IN"===e||"TOKEN_REFRESHED"===e)try{await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:t.access_token,refresh_token:t.refresh_token}),credentials:"include"})}catch(e){console.warn("Failed to sync auth cookies on state change:",e)}h(t.user.id)}else u(null),d(!1)});return()=>{t.unsubscribe()}},[]);let h=async e=>{try{let{data:t,error:r}=await n.N.from("users").select("*").eq("id",e).single();if(r)throw r;u(t)}catch(e){console.error("Error fetching user data:",e),u(null)}finally{d(!1)}},m=async(e,t)=>{try{console.log("Attempting sign in for:",e),await n.N.auth.signOut();let{data:r,error:s}=await n.N.auth.signInWithPassword({email:e,password:t});return r.session&&await fetch("/api/auth/cookie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:r.session.access_token,refresh_token:r.session.refresh_token}),credentials:"include"}),{error:s}}catch(e){return console.error("Unexpected error during sign in:",e),{error:e}}},g=async()=>{try{await n.N.auth.signOut(),console.log("Sign out completed. Session cleared.")}catch(e){console.error("Error signing out:",e)}},f=async(e,t,r)=>{try{console.log("Attempting sign up for:",e);let{data:o,error:a}=await n.N.auth.signUp({email:e,password:t,options:{data:{name:r},emailRedirectTo:"".concat(window.location.origin,"/signin")}});if(a)throw a;let i={success:!a,user:o.user?"".concat(o.user.email):"Missing",session:o.session?"Present":"Missing (email confirmation may be required)"};console.log("Sign up response:",i);let l=!o.session;if(o.user){var s;return{error:null,requiresEmailConfirmation:l,email:null!=(s=o.user.email)?s:e}}throw Error("Signup failed. Please try again.")}catch(e){return console.error("Error during sign up:",e),{error:e,requiresEmailConfirmation:!1}}},p=async e=>{try{let{error:t}=await n.N.auth.resetPasswordForEmail(e,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(t)return{error:t};return{error:null}}catch(e){return console.error("Error sending password reset email:",e),{error:e}}},b=async(e,t)=>{try{let{data:r,error:s}=await n.N.auth.signInWithOAuth({provider:e,options:{redirectTo:null!=t?t:"".concat(window.location.origin,"/"),queryParams:{prompt:"select_account"}}});if(s)throw s;return{error:null}}catch(e){return console.error("OAuth sign-in error:",e),{error:e}}};return(0,s.jsx)(a.Provider,{value:{user:r,dbUser:l,loading:c,signIn:m,signOut:g,signUp:f,signInWithProvider:b,resetPassword:p,checkPermission:e=>{let t=null==l?void 0:l.role;return!!t&&("admin"===e?"admin"===t:"teacher"===e?"admin"===t||"teacher"===t:"student"===e)}},children:t})}function l(){let e=(0,o.useContext)(a);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},402:(e,t,r)=>{Promise.resolve().then(r.bind(r,8246))},6414:(e,t,r)=>{"use strict";r.d(t,{N:()=>l});var s=r(5647);let o="https://qrowzznnnarfogfbnnow.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb3d6em5ubmFyZm9nZmJubm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjg1MzUsImV4cCI6MjA2NzY0NDUzNX0.MkCeFSLoOyGl-y1_eZTXTXXV8hGOJM7WuBV7gvLc_rI";if(!o)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_URL");if(!n)throw Error("Missing env.NEXT_PUBLIC_SUPABASE_ANON_KEY");let a=(()=>{if(!o)return"default";let e=o.match(/https:\/\/([a-z0-9-]+)\.supabase\.co/);return e?e[1]:"default"})();console.log("Supabase project ref for cookies:",a);let i={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storageKey:"sb-".concat(a,"-auth-token"),cookieOptions:{name:"sb-".concat(a,"-auth-token"),path:"/",sameSite:"Lax",secure:!0,maxAge:604800}}};console.log("Supabase client initialized with cookie config:",{cookieName:i.auth.cookieOptions.name,cookiePath:i.auth.cookieOptions.path,detectSessionInUrl:i.auth.detectSessionInUrl,persistSession:i.auth.persistSession});let l=(0,s.UU)(o,n,i);l.auth.getUser().then(()=>{}),l.auth.onAuthStateChange((e,t)=>{console.log("Supabase auth event:",e)}),window.addEventListener("focus",()=>{l.auth.refreshSession().catch(e=>{console.error("Error refreshing Supabase session on focus:",e)})})},8246:(e,t,r)=>{"use strict";r.d(t,{ResetPassword:()=>l});var s=r(5155),o=r(2115),n=r(20),a=r(6874),i=r.n(a);function l(){let{resetPassword:e}=(0,n.As)(),[t,r]=(0,o.useState)(""),[a,l]=(0,o.useState)(null),[u,c]=(0,o.useState)(!1),[d,h]=(0,o.useState)(!1),m=async r=>{r.preventDefault(),l(null),c(!1),h(!0);try{let{error:r}=await e(t);if(r)throw r;c(!0)}catch(e){l(e.message)}finally{h(!1)}};return(0,s.jsxs)("div",{className:"mx-auto max-w-md rounded-lg bg-white p-6 shadow-md dark:bg-gray-800",children:[(0,s.jsx)("h2",{className:"mb-6 text-2xl font-bold text-gray-900 dark:text-white",children:"R\xe9initialiser le mot de passe"}),a&&(0,s.jsx)("div",{className:"mb-4 rounded-lg bg-red-100 p-4 text-red-700",role:"alert",children:a}),u&&(0,s.jsx)("div",{className:"mb-4 rounded-lg bg-green-100 p-4 text-green-700",role:"alert",children:"V\xe9rifiez votre e-mail pour les instructions de r\xe9initialisation du mot de passe."}),(0,s.jsxs)("form",{onSubmit:m,children:[(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsx)("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Adresse e-mail"}),(0,s.jsx)("input",{id:"email",type:"email",value:t,onChange:e=>r(e.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",required:!0})]}),(0,s.jsx)("button",{type:"submit",disabled:d,className:"flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50",children:d?"Envoi en cours...":"R\xe9initialiser le mot de passe"})]}),(0,s.jsx)("div",{className:"mt-4 text-center",children:(0,s.jsx)(i(),{href:"/signin",className:"text-sm text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300",children:"Retour \xe0 la connexion"})})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[5647,6874,8441,1684,7358],()=>t(402)),_N_E=e.O()}]);