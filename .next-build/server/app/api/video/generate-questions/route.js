(()=>{var e={};e.id=6407,e.ids=[6407],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28086:(e,t,r)=>{"use strict";r.d(t,{t:()=>i});var s=r(34386),n=r(44999);async function i(){let e=await (0,n.UL)();return(0,s.createServerClient)("https://qrowzznnnarfogfbnnow.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb3d6em5ubmFyZm9nZmJubm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjg1MzUsImV4cCI6MjA2NzY0NDUzNX0.MkCeFSLoOyGl-y1_eZTXTXXV8hGOJM7WuBV7gvLc_rI",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:s})=>e.set(t,r,s))}catch{}}}})}},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},37830:e=>{"use strict";e.exports=require("node:stream/web")},39727:()=>{},43149:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{OPTIONS:()=>g,POST:()=>d});var n=r(96559),i=r(48088),o=r(37719),a=r(32190),c=r(37647),l=r(28086);function u(e){let t=e.trim().split(":"),r=0,s=0,n=0;return 3===t.length?(r=Number(t[0]),s=Number(t[1]),n=Number(t[2].replace(",","."))):2===t.length&&(s=Number(t[0]),n=Number(t[1].replace(",","."))),Number.isNaN(r)&&(r=0),Number.isNaN(s)&&(s=0),Number.isNaN(n)&&(n=0),3600*r+60*s+n}function p(e){return e.toLowerCase().replace(/[^a-z0-9àâäçéèêëîïôöùûüñ\s]/gi," ").split(/\s+/).filter(e=>e.length>=4)}async function d(e){try{let t,r=process.env.OPENAI_API_KEY;if(!r)return a.NextResponse.json({error:"Missing OPENAI_API_KEY"},{status:500});let s=await e.json().catch(()=>null),n=s?.sectionId,i=Math.min(8,Math.max(1,Number(s?.maxQuestions??8)));if(!n)return a.NextResponse.json({error:"Missing sectionId"},{status:400});let o=await (0,l.t)(),d=String(n),g=`${d}/captions.vtt`,{data:m,error:f}=await o.storage.from("translations").download(g);if(f||!m)return a.NextResponse.json({error:`Unable to download captions: ${f?.message||"not found"}`},{status:404});let h=await m.text();if(!h||0===h.trim().length)return a.NextResponse.json({error:"Empty captions"},{status:422});let y=function(e){let t=e.split(/\r?\n/),r=[],s=0;for(t[0]&&/^WEBVTT/i.test(t[s])&&s++;s<t.length;){for(;s<t.length&&""===t[s].trim();)s++;if(s<t.length&&t[s].match(/^[A-Za-z0-9\-_. ]+$/)&&!t[s].includes("--\x3e")&&s++,s>=t.length)break;let e=t[s++];if(!e||!e.includes("--\x3e"))continue;let[n,i]=e.split("--\x3e").map(e=>e.trim()),o=u(n),a=u((i||"").split(" ")[0]),c=[];for(;s<t.length&&""!==t[s].trim();)c.push(t[s]),s++;let l=c.join(" ").trim();Number.isNaN(o)||Number.isNaN(a)||!(a>o)||r.push({start:o,end:a,text:l})}return r}(h),x=new c.Ay({apiKey:r}),N=[`Create up to ${i} mixed-type questions (flashcard, fillBlank, matchingGame) from this WebVTT transcript. Output ONLY the JSON array described.`,h.length>12e4?h.slice(0,12e4):h].join("\n"),b=await x.chat.completions.create({model:process.env.OPENAI_MODEL_ID||"gpt-4o-mini",temperature:.4,messages:[{role:"system",content:'You generate a VARIED set of learning questions for children (ages 7–11) from a WebVTT transcript.\nReturn ONLY a valid JSON array of up to N items. No prose, no code fences.\nAllowed types and strict shapes:\n- flashcard: { "id": number, "type": "flashcard", "question": string, "choices": string[3-6], "correctAnswer": string }\n- fillBlank: { "id": number, "type": "fillBlank", "title"?: string, "instructions"?: string, "sentence": string (contains exactly one "____"), "choices": string[3-6], "correctAnswer": string, "feedback"?: { "correct"?: string, "incorrect"?: string } }\n- matchingGame: { "id": number, "type": "matchingGame", "title"?: string, "instructions"?: string, "pairs": Array<{"left": string, "right": string}> (3-8), "feedback"?: { "correct"?: string, "incorrect"?: string } }\nRules:\n- Use the same language as the transcript.\n- Keep wording simple, friendly, and sensory-friendly. Grade 2–5 reading level.\n- Each item should test a single clear idea from the transcript.\n- Mix the three types to keep engagement high; avoid duplicates.\n- Ensure every flashcard has exactly one correct answer present in choices.\n- For fillBlank, sentence MUST include exactly one ____ and correctAnswer MUST be one of choices.\n- For matchingGame, provide meaningful left/right pairs based on transcript facts.'},{role:"user",content:N}]}),v=b.choices?.[0]?.message?.content?.trim()||"";try{t=JSON.parse(v)}catch(e){return a.NextResponse.json({error:"Invalid JSON from model",raw:v},{status:502})}if(!Array.isArray(t))return a.NextResponse.json({error:"Model did not return an array",raw:v},{status:502});let k=new Set(["flashcard","fillBlank","matchingGame"]),q=t.map((e,t)=>{let r=Number(e?.id??t+1),s=String(e?.type||"").trim();if(!r||r<=0||!k.has(s))return null;if("flashcard"===s){let t=String(e?.question||"").trim(),s=Array.isArray(e?.choices)?e.choices.map(e=>String(e)).slice(0,6):[],n=String(e?.correctAnswer||"").trim();return t&&!(s.length<3)&&n&&s.includes(n)?{id:r,type:"flashcard",question:t,choices:s,correctAnswer:n}:null}if("fillBlank"===s){let t=e?.title!=null?String(e.title):void 0,s=e?.instructions!=null?String(e.instructions):void 0,n=String(e?.sentence||"").trim(),i=Array.isArray(e?.choices)?e.choices.map(e=>String(e)).slice(0,6):[],o=String(e?.correctAnswer||e?.correct_answer||"").trim(),a=e?.feedback&&"object"==typeof e.feedback?{correct:null!=e.feedback.correct?String(e.feedback.correct):void 0,incorrect:null!=e.feedback.incorrect?String(e.feedback.incorrect):void 0}:void 0,c=(n.match(/____/g)||[]).length;return n&&1===c&&!(i.length<3)&&o&&i.includes(o)?{id:r,type:"fillBlank",title:t,instructions:s,sentence:n,choices:i,correctAnswer:o,feedback:a}:null}if("matchingGame"===s){let t=e?.title!=null?String(e.title):void 0,s=e?.instructions!=null?String(e.instructions):void 0,n=(Array.isArray(e?.pairs)?e.pairs:[]).map(e=>({left:String(e?.left||"").trim(),right:String(e?.right||"").trim()})).filter(e=>e.left&&e.right).slice(0,8),i=e?.feedback&&"object"==typeof e.feedback?{correct:null!=e.feedback.correct?String(e.feedback.correct):void 0,incorrect:null!=e.feedback.incorrect?String(e.feedback.incorrect):void 0}:void 0;return n.length<3?null:{id:r,type:"matchingGame",title:t,instructions:s,pairs:n,feedback:i}}return null}).filter(e=>null!==e).slice(0,i);if(0===q.length)return a.NextResponse.json({error:"No valid questions parsed",raw:v},{status:502});return q=function(e,t){if(!Array.isArray(e)||0===e.length)return t;let r=e.map(e=>p(e.text)),s=e=>{if("flashcard"===e.type)return p(`${e.question} ${e.correctAnswer}`);if("fillBlank"===e.type)return p(`${e.sentence} ${e.correctAnswer}`);let t=e.pairs.map(e=>`${e.left} ${e.right}`).join(" ");return p(`${e.title||""} ${e.instructions||""} ${t}`)};return t.map((n,i)=>{let o=new Set(s(n)),a=-1,c=-1;for(let t=0;t<e.length;t++){let e=r[t];if(!e||0===e.length)continue;let s=0;for(let t of e)o.has(t)&&s++;s>c&&(c=s,a=t)}(-1===a||0===c)&&(a=Math.min(e.length-1,Math.floor((i+1)/(t.length+1)*e.length)));let l=e[a];return n.startTime=l.start,n.endTime=l.end,n})}(y,q),a.NextResponse.json({questions:q},{status:200})}catch(e){return console.error("[generate-questions] Error:",e),a.NextResponse.json({error:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function g(){return a.NextResponse.json({},{status:200})}let m=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/video/generate-questions/route",pathname:"/api/video/generate-questions",filename:"route",bundlePath:"app/api/video/generate-questions/route"},resolvedPagePath:"C:\\Users\\Konan\\Documents\\MONSPACE\\CourseWebsite-1\\app\\api\\video\\generate-questions\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:h,serverHooks:y}=m;function x(){return(0,o.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:h})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},57075:e=>{"use strict";e.exports=require("node:stream")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{"use strict";e.exports=require("node:fs")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580,6570,645,4386,4999,7294,7647],()=>r(43149));module.exports=s})();