(()=>{var e={};e.id=666,e.ids=[666],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},37830:e=>{"use strict";e.exports=require("node:stream/web")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55591:e=>{"use strict";e.exports=require("https")},57075:e=>{"use strict";e.exports=require("node:stream")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64636:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>g,routeModule:()=>d,serverHooks:()=>f,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{OPTIONS:()=>p,POST:()=>l});var n=r(96559),a=r(48088),i=r(37719),o=r(32190),u=r(37647);function c(e){let t=e.match(/^(\d{1,2}):(\d{2}):(\d{2})(?:[\.,](\d{1,3}))?$/)||e.match(/^(\d{1,2}):(\d{2})(?:[\.,](\d{1,3}))?$/);if(!t)return null;if(5===t.length){let e=Number(t[1]);return 3600*e+60*Number(t[2])+Number(t[3])}return 60*Number(t[1])+Number(t[2])}async function l(e){try{let t,r=process.env.OPENAI_API_KEY;if(!r)return o.NextResponse.json({error:"Missing OPENAI_API_KEY"},{status:500});let s=await e.json().catch(()=>null);if(!s||!s.captions)return o.NextResponse.json({error:"Missing captions in request body"},{status:400});let{captions:n,language:a="fr",targetChapterCount:i}=s,l=new u.Ay({apiKey:r}),p=function(e,t){let{maxChars:r=32e3,maxWindows:s=1200}=t||{},n=function(e){let t=e.split(/\n\n+/),r=[];for(let e of t){if(/^WEBVTT/i.test(e.trim()))continue;let t=e.match(/(\d{1,2}:\d{2}(?::\d{2})?(?:[\.,]\d{1,3})?)\s*-->\s*(\d{1,2}:\d{2}(?::\d{2})?(?:[\.,]\d{1,3})?)/);if(!t)continue;let s=c(t[1]),n=c(t[2]);if(null==s||null==n)continue;let a=e.split("\n").slice(1).join(" ").replace(/<[^>]+>/g," ").replace(/[\[\(][^\]\)]*[\)\]]/g," ").replace(/\s+/g," ").trim();a&&(/^(music|applause|silence|noise)$/i.test(a)||r.push({start:s,end:n,text:a}))}return r}(e);if(0===n.length)return e.slice(0,Math.max(8e3,Math.min(r,2e4)));let a=Math.max(...n.map(e=>e.end)),i=Math.max(30,Math.ceil(a/Math.max(1,s))),o=[],u=0;for(;u<=a;)o.push({t:u,text:[]}),u+=i;for(let e of n){let t=Math.min(o.length-1,Math.floor(e.start/i));o[t].text.push(e.text)}let l=[];for(let e of o){if(0===e.text.length)continue;let t=new Set,s=[];for(let r of e.text){let e=r.toLowerCase();if(!t.has(e)&&(t.add(e),s.push(r),s.join(" ").length>300))break}let n=`${(function(e){let t=Math.floor(e/60),r=Math.floor(e%60);return`${String(t).padStart(2,"0")}:${String(r).padStart(2,"0")}`})(e.t)} ${s.join(" ")}`.trim();if(l.push(n),l.join("\n").length>r)break}let p=l.join("\n");if(p.length>r){let e=[];for(let t=0;t<l.length;t+=2)e.push(l[t]);p=e.join("\n").slice(0,r)}return`TIMELINE
${p}`}(n,{maxChars:32e3,maxWindows:1200}),d=[`Language: ${a}`,i?`Target chapters: ${i}`:"Target chapters: auto",'Input is a condensed timeline with time anchors in the format "MM:SS text" (one per window).',"Use the anchors and content to infer global chapter boundaries and titles. Return absolute startTime in seconds.","Return ONLY the JSON array as specified. Do not include comments or explanations.",'For each chapter, include a boolean field "flashcard" (true/false) as required by the rules.',"```",p,"```"].join("\n"),h=await l.chat.completions.create({model:process.env.OPENAI_MODEL_ID||"gpt-4o-mini",temperature:.3,messages:[{role:"system",content:'You are an assistant that creates structured video chapters from a transcript or caption file.\nThe output must be ONLY a valid JSON array of chapter objects, nothing else. No code fences, no prose.\nEach chapter object MUST have: "title" (string), "startTime" (number, seconds), "duration" (number, seconds), "description" (string) and "flashcard" (boolean).\nRules:\n- Use the transcript timing to choose reasonable chapter boundaries.\n- Ensure startTime values are increasing and start at 0 or the first meaningful point.\n- If duration is provided, ensure it is positive and non-overlapping with the next chapter.\n- Keep titles short and descriptive; use the transcript language.\n- If no clear structure, create 4-8 logical chapters depending on length.\n- If targetChapterCount is provided, aim for that many chapters (but keep quality).\n- Set flashcard to true when the chapter contains a focused fact, definition, key concept, or short list suitable for a single multiple-choice question. Otherwise set flashcard to false.\n- ALWAYS include the flashcard boolean field for every chapter.'},{role:"user",content:d}]}),m=h.choices?.[0]?.message?.content?.trim()||"";try{t=JSON.parse(m)}catch(r){let e=m.match(/\[[\s\S]*\]/);e&&(t=JSON.parse(e[0]))}if(!Array.isArray(t))return o.NextResponse.json({error:"Model did not return a JSON array",raw:m},{status:502});console.log(t);let f=e=>{if("boolean"==typeof e)return e;if("string"==typeof e){let t=e.trim().toLowerCase();return"true"===t||"yes"===t||"1"===t}return"number"==typeof e&&0!==e},g=t.map(e=>{let t=String(e?.title||"").slice(0,200).trim(),r=Number(e?.startTime),s=e?.duration!=null?Number(e.duration):void 0,n=e?.description!=null?String(e.description).slice(0,500).trim():void 0,a=f(e?.flashcard);return{title:t,startTime:r,duration:s,description:n,flashcard:a}}).filter(e=>e.title&&Number.isFinite(e.startTime)&&e.startTime>=0).sort((e,t)=>e.startTime-t.startTime);if(0===g.length)return o.NextResponse.json({error:"No valid chapters parsed",raw:m},{status:502});for(let e=1;e<g.length;e++)g[e].startTime<=g[e-1].startTime&&(g[e].startTime=g[e-1].startTime+1);return o.NextResponse.json({chapters:g},{status:200})}catch(e){return console.error("[generate-chapters] Error:",e),o.NextResponse.json({error:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function p(){return o.NextResponse.json({},{status:200})}let d=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/upload-video/generate-chapters/route",pathname:"/api/upload-video/generate-chapters",filename:"route",bundlePath:"app/api/upload-video/generate-chapters/route"},resolvedPagePath:"C:\\Users\\Konan\\Documents\\MONSPACE\\CourseWebsite-1\\app\\api\\upload-video\\generate-chapters\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:h,workUnitAsyncStorage:m,serverHooks:f}=d;function g(){return(0,i.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:m})}},73024:e=>{"use strict";e.exports=require("node:fs")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580,6570,7294,7647],()=>r(64636));module.exports=s})();